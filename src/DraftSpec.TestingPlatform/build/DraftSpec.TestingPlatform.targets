<?xml version="1.0" encoding="utf-8"?>
<Project>
  <!-- Collect CSX spec files as content -->
  <ItemGroup>
    <DraftSpecFile Include="$(DraftSpecPattern)" Exclude="**/bin/**;**/obj/**" />
    <Content Include="@(DraftSpecFile)" CopyToOutputDirectory="PreserveNewest" />
  </ItemGroup>

  <!-- Also include helper CSX files (loaded via #load) -->
  <ItemGroup>
    <DraftSpecHelperFile Include="**/*_helper.csx;**/spec_helper.csx" Exclude="**/bin/**;**/obj/**" />
    <Content Include="@(DraftSpecHelperFile)" CopyToOutputDirectory="PreserveNewest" />
  </ItemGroup>

  <!-- Generate entry point by copying template -->
  <Target Name="GenerateDraftSpecEntryPoint"
          BeforeTargets="BeforeCompile"
          Condition="'$(GenerateTestingPlatformEntryPoint)' == 'true'">

    <PropertyGroup>
      <DraftSpecEntryPointDir>$(IntermediateOutputPath)generated/</DraftSpecEntryPointDir>
      <DraftSpecEntryPoint>$(DraftSpecEntryPointDir)DraftSpec.EntryPoint.g.cs</DraftSpecEntryPoint>
      <DraftSpecTemplateFile>$(MSBuildThisFileDirectory)EntryPoint.template.cs</DraftSpecTemplateFile>
    </PropertyGroup>

    <MakeDir Directories="$(DraftSpecEntryPointDir)" />

    <Copy SourceFiles="$(DraftSpecTemplateFile)"
          DestinationFiles="$(DraftSpecEntryPoint)"
          SkipUnchangedFiles="true" />

    <ItemGroup>
      <Compile Include="$(DraftSpecEntryPoint)" />
    </ItemGroup>
  </Target>
</Project>
